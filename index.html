<html lang="es"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> - FacturaElectronica</title>
    <link rel="stylesheet" href="/recursos/lib/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/recursos/css/site.css?v=MftKk_Dl6T7dEmsIjqGv2uBKatQlxWlkRm2f9VL-UFU">
    <link rel="stylesheet" href="/recursos/FacturaElectronica.styles.css?v=ZYO3_Z7cbhX2aVP1oaGBL85H1zMc-MIt6Tv0637hCq8">
    <script src="/recursos/lib/jquery/dist/jquery.min.js"></script>
    <script src="/recursos/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/recursos/js/site.js?v=hRQyftXiu1lLX2P9Ly9xa4gHJgLeR1uGN5qegUobtGo"></script>
    <script src="/recursos/lib/xlsx/xlsx.full.min.js"></script>

    


</head>
<body>
    <header b-ug7pci6d7i="">
        <div b-ug7pci6d7i="" class="container">

        <nav b-ug7pci6d7i="" class="navbar navbar-expand-sm navbar-dark bg-dark  navbar-toggleable-sm  border-bottom box-shadow mb-3">
           
                <a class="navbar-brand" href="/">Contador FRIENDLY</a>
                <button b-ug7pci6d7i="" class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target=".navbar-collapse" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span b-ug7pci6d7i="" class="navbar-toggler-icon"></span>
                </button>
                <div b-ug7pci6d7i="" class="navbar-collapse collapse d-sm-inline-flex justify-content-between">

                    <a b-ug7pci6d7i="" type="button" href="https://sv.linkedin.com/in/henry-james-monterroza-d%C3%ADaz-6281501b5" target="_blank" class="btn btn-primary">
                        <svg b-ug7pci6d7i="" width="16" height="16" fill="currentColor" class="bi bi-linkedin" viewBox="0 0 16 16">
                            <path b-ug7pci6d7i="" d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854zm4.943 12.248V6.169H2.542v7.225zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248S2.4 3.226 2.4 3.934c0 .694.521 1.248 1.327 1.248zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016l.016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225z"></path>
                        </svg>
                        Developer
                    </a>
                </div>
            
        </nav>
        </div>
    </header>
    <div b-ug7pci6d7i="" class="container">
        <main b-ug7pci6d7i="" role="main" class="pb-3">
            <div class="container">
    <div class="row justify-content-center align-items-center">
        <div class="col-md-6">
            <div class="row">
                <div class="col-md-12">
                    <h2 class="mb-4 text-center">Componer Libro de Compras</h2>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <label for="filename">Nombre del Archivo:</label>
                    <input type="text" class="form-control" id="filename" placeholder="Nombre del archivo">
                </div>
                <div class="col-md-6">
                    <button type="button" class="btn btn-outline-success mt-4 w-100" id="exportBtn">
                        <svg width="16" height="16" fill="currentColor" class="bi bi-cloud-upload" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.569 14.502 11 12.687 11H10a.5.5 0 0 1 0-1h2.688C13.979 10 15 8.988 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-2.941 1.1c-.757.652-1.153 1.438-1.153 2.055v.448l-.445.049C2.064 4.805 1 5.952 1 7.318 1 8.785 2.23 10 3.781 10H6a.5.5 0 0 1 0 1H3.781C1.708 11 0 9.366 0 7.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383"></path>
                            <path fill-rule="evenodd" d="M7.646 4.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V14.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708z"></path>
                        </svg> Procesar Archivos
                    </button>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <label for="formFileMultiple" class="form-label">Seleccione almenos un archivo JSON</label>
                    <input class="form-control" type="file" id="formFileMultiple" multiple="" accept=".json">
                </div>
            </div>

            <div class="row">
                <div class="col-md-12 mt-3">
                    <div id="downloaddiv" role="alert">
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <div id="msjAlert" role="alert">
                    </div>
                </div>
            </div>


        </div>
    </div>
</div>

<script>
    var btnDown =
        `<a type="button" class="btn btn-outline-primary mt-3" href="default.asp" target="_blank" id="download" >
            <svg  width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5">
            </path>
            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708z"></path>
            </svg>
            </a>`

    function AlertDiv(msj) {
        var alertDiv = `<div class="alert alert-warning alert-dismissible fade show mt-3" role="alert">
                ${msj}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>`
        return alertDiv;
    }



    $(document).ready(function () {
        // Evento change del input file para habilitar/deshabilitar el botón de exportar
        $("#formFileMultiple").change(function () {
            let files = $(this).prop("files");
            if (files.length == 0) {
                $("#exportBtn").prop("disabled", true);
            } else {
                $("#exportBtn").prop("disabled", false);
            }
        });

        // Evento click del botón exportar
        $("#exportBtn").click(async function () {
            // Deshabilitar el botón mientras se procesa
            $("#exportBtn").prop('disabled', true);

            // Limpiar mensajes de alerta previos
            $("#msjAlert").empty();

            // Obtener archivos seleccionados
            let files = $("#formFileMultiple").prop("files");

            // Validar que se haya seleccionado al menos un archivo
            if (files.length == 0) {
                let alerty = AlertDiv("Debe Seleccionar Al menos un Archivo JSON");
                $("#msjAlert").append(alerty);
                $("#formFileMultiple").focus();
                $("#exportBtn").prop('disabled', false);
                return;
            }

            // Validar que se haya ingresado un nombre para el archivo
            let filename = $("#filename").val();
            if (isNullOrEmpty(filename)) {
                let alerty = AlertDiv("Ingrese un nombre para el archivo");
                $("#msjAlert").append(alerty);
                $("#exportBtn").prop('disabled', false);
                $("#filename").focus();
                return;
            }

            // Array para almacenar los datos de los archivos JSON
            var ElectronicArray = [];
            try {
                // Leer cada archivo JSON seleccionado y parsearlo
                for (var i = 0; i < files.length; i++) {
                    var file = files[i];
                    let jsonstring = await readFileAsText(file);
                    let objjson = JSON.parse(jsonstring);
                    ElectronicArray.push(objjson);
                }
            } catch (ex) {
                // Mostrar mensaje de error si ocurre un problema al procesar los archivos JSON
                let alerty = AlertDiv("Los archivos JSON no tienen la estructura esperada. " + ex);
                $("#msjAlert").append(alerty);
                $("#exportBtn").prop('disabled', false);
                return;
            }

            // Array para almacenar los datos que se convertirán en el archivo Excel
            var excelarray = [];
            for (var i = 0; i < ElectronicArray.length; i++) {
                try {
                    var objson = ElectronicArray[i];
                    let obj = {
                        "Correlativo": `${i + 1}`,
                        "FechaEmision": objson.identificacion.fecEmi,
                        "NumeroUnicoComprobante": objson.identificacion.codigoGeneracion,
                        "NumeroComprobante": objson.identificacion.numeroControl,
                        "NumeroRegistro": objson.emisor.nrc,
                        "NumeroSerie": objson.selloRecibido || objson.respuestaHacienda.selloRecibido,
                        "NIToDUI": objson.emisor.nit,
                        "NombreProveedor": objson.emisor.nombre,
                        "ComprasExentaInterna": objson.resumen.totalExenta,
                        "ComprasExentaExterna": 0.0,
                        "ComprasGrabadasInterna": objson.resumen.totalGravada,
                        "ComprasGrabadasExterna": 0.0,
                        "CreditoFiscal": 0.0,
                        "Percepcion": 0.0,
                        "TotalCompras": objson.resumen.montoTotalOperacion,
                        "ComprasSujetosExcluidos": objson.resumen.descuNoSuj
                    };
                    excelarray.push(obj);
                } catch (ex) {
                    // Mostrar mensaje de error si hay un problema con la estructura del JSON
                    let alerty = AlertDiv("Los archivos JSON no tienen la estructura esperada. " + ex);
                    $("#msjAlert").append(alerty);
                    $("#exportBtn").prop('disabled', false);
                    return;
                }
            }

            // Mostrar en consola el JSON que se convertirá a tabla de Excel
            console.log("JSON Tabla de excel");
            console.log(JSON.stringify(excelarray));

            // Convertir el JSON a una hoja de cálculo y descargar el archivo Excel
            TabularJson(excelarray);

            // Habilitar el botón de exportar y limpiar los campos
            $("#exportBtn").prop('disabled', false);
            $("#formFileMultiple").val(null);
            $("#filename").val(null);

            // Puedes realizar aquí tu solicitud AJAX si es necesario
            // ajaxRequest(``, excelarray)
        });

        // Inicializar los campos y botones al cargar la página
        $("#exportBtn").prop('disabled', false);
        $("#formFileMultiple").val(null);
        $("#filename").val(null);
    });

    // Función para convertir una cadena base64 en bytes
    function base64ToBytes(base64String) {
        let binaryString = atob(base64String);
        let len = binaryString.length;
        let bytes = new Uint8Array(len);

        for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }

        return bytes;
    }

    // Función para leer un archivo como texto
    function readFileAsText(file) {
        return new Promise((resolve, reject) => {
            if (!file.type.match('text.*') && !file.type.match('application/json')) {
                reject('El archivo debe ser de tipo texto o JSON.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (event) {
                const contents = event.target.result;
                resolve(contents);
            };
            reader.onerror = function (error) {
                reject('Error al leer el archivo: ' + error);
            };
            reader.readAsText(file);
        });
    }

    // Función para convertir un JSON en una hoja de cálculo y descargarla
    function TabularJson(json) {
        // Convertir JSON a una hoja de cálculo
        const worksheet = XLSX.utils.json_to_sheet(json);

        // Crear un nuevo libro de trabajo
        const workbook = XLSX.utils.book_new();

        // Añadir la hoja de cálculo al libro de trabajo
        XLSX.utils.book_append_sheet(workbook, worksheet, "Sheet1");

        // Generar un archivo Excel y descargarlo
        let filenombre = $("#filename").val();
        XLSX.writeFile(workbook, `${filenombre}.xlsx`);
    }

    // Función para verificar si una cadena es nula o vacía
    function isNullOrEmpty(str) {
        return !str || str.trim() === '';
    }

</script>




        </main>
    </div>

    <footer b-ug7pci6d7i="" class="footer text-muted">
        <div b-ug7pci6d7i="" class="container">
            © 2024 - FacturaElectronica -<!--  <a href="/Home/Privacy">Privacy</a> -->
        </div>
    </footer>

    

<!-- Visual Studio Browser Link -->
<script type="text/javascript" src="/_vs/browserLink" async="async" id="__browserLink_initializationData" data-requestid="d64706b8d31a477dbdf817bf4a969d43" data-requestmappingfromserver="false" data-connecturl="http://localhost:50238/ee1a454ff0b74d0f825aceccfad8bd5d/browserLink"></script>
<!-- End Browser Link -->
<script src="/_framework/aspnetcore-browser-refresh.js"></script>

</body></html>